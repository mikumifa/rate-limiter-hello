## 云原生大作业说明文档
### 组员信息及分工
|姓名|学号|邮箱|分工|
|-|-|-|-|
|赵政杰|211250109|3239168744@qq.com|文档书写，Prometheus+grafana配置监控及压力测试|
|徐子豪|211250110|||
|谢其卓|211870187|||
本组为 nju23 组
本组使用 github 仓库进行协同开发，通过 QQ 合作交流
github仓库地址：https://github.com/mikumifa/rate-limiter-hello.git
### 目录
[toc]
### 作业要求
开发一个 Spring Boot 应用，并使用云原生功能
具体要求：https://doc.weixin.qq.com/doc/w3_AK4AcQYdAN0amWA7Kk4RX2ulwKZbs?scode=ABoAuwfGAAkWJM0xI3AK4AcQYdAN0
### 项目实现
#### 1.基本功能
#### 2.DevOps功能
#### 3.扩容场景
##### 3.1Prometheus与Grafana的可视化监控
编写`prometheus.yml`文件，通过该 Java 项目提供的/actuator/prometheus接口，以供 Prometheus 采集监控指标
目标是本机ip的8080端口（项目运行在容器中时，通过8080端口映射）
![](https://box.nju.edu.cn/f/9f1c872c2b014ed7b7ba/?dl=1)
编写 docker 配置文件`docker-compose.yml`，它用来在 docker 上安装和配置 Grafana
其中 Grafana 使用3030端口，Prometheus 使用9090端口
![](https://box.nju.edu.cn/f/d9fed3361b98412a9666/?dl=1)
运行`docker-compose.yml`配置文件，可以看到 docker 中有两个正在运行的容器，分别为 Grafana 和 Prometheus，它们在同一网络下
![](https://box.nju.edu.cn/f/041dc413a3894f9c9daf/?dl=1)
运行已经构建好的`hello-rate-limiter`镜像（映射到本机的8080端口）
![](https://box.nju.edu.cn/f/82a8fbd25d654e31842c/?dl=1)
查看 Prometheus 的端口，可以看到 target 中 spring-boot 的监测接口是 up 状态
![](https://box.nju.edu.cn/f/d1437dde9d2848dda635/?dl=1)
查看 Grafana 的端口，用户名和初始密码均为`admin`
![](https://box.nju.edu.cn/f/353fd7aad60a41a6a064/?dl=1)
##### 3.2Grafana 定制应用监控大屏
首先设置数据源，进入 Grafana 后，在左侧 Data Source 即数据源选项，点 Add Data Source 即添加数据源，选择 Prometheus
![](https://box.nju.edu.cn/f/da50418b0f4c4a40a338/?dl=1)
![](https://box.nju.edu.cn/f/479fd4280f8a41f59616/?dl=1)
之后设置数据源 URL，填入`http://prometheus-1:9090`（prometheus-1为 Prometheus 容器的名字）
![](https://box.nju.edu.cn/f/5c4e95d044ae43989ff7/?dl=1)
之后点击`save and test`，看到`Data source is working`，表明 Grafana 已经联系到 Prometheus
![](https://box.nju.edu.cn/f/cacb851c53e84b00b84c/?dl=1)
使用图形化界面配置仪表盘，分别检测该项目的CPU使用率（system_cpu_usage）、内存使用率（jvm_memory_used_bytes）和每10s的平均http请求数（rate(http_server_requests_seconds_count[10s])
![](https://box.nju.edu.cn/f/4f7799255caf4e28ae2a/?dl=1)
![](https://box.nju.edu.cn/f/d90a11a9a95d41928b0f/?dl=1)
![](https://box.nju.edu.cn/f/53337052ba6a4e4c937c/?dl=1)
最后的效果如下
![](https://box.nju.edu.cn/f/1982d1f9f0d744e0a1a4/?dl=1)
##### 3.3通过使用 Jmeter 工具对接口进压测，在 Grafana 中观察监控数据
在 Jmeter 中使用300线程，循环5次对接口`http://localhost:8080/hello`进行压力测试
![](https://box.nju.edu.cn/f/fa52f8aa83ee452b8cbb/?dl=1)
压测前的状态（最近五分钟）
![](https://box.nju.edu.cn/f/41431ac632b447689fd1/?dl=1)
压测后的状态（最近五分钟）
![](https://box.nju.edu.cn/f/ac566e564d2a4c34bc96/?dl=1)
可以看到，压测过程中CPU使用率和http请求数都增大一段时间
在 Jmeter 中也出现了访问次数过多的返回429的情况
![](https://box.nju.edu.cn/f/dde5884866554d0fab7e/?dl=1)